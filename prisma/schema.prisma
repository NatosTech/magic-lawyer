generator client {
  provider = "prisma-client-js"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  ADVOGADO
  SECRETARIA
  FINANCEIRO
  CLIENTE
}

enum TenantStatus {
  ACTIVE
  SUSPENDED
  CANCELLED
}

enum TipoPessoa {
  FISICA
  JURIDICA
}

enum ProcessoStatus {
  RASCUNHO
  EM_ANDAMENTO
  SUSPENSO
  ENCERRADO
  ARQUIVADO
}

enum MovimentacaoTipo {
  ANDAMENTO
  PRAZO
  INTIMACAO
  AUDIENCIA
  ANEXO
  OUTRO
}

enum ContratoStatus {
  RASCUNHO
  ATIVO
  SUSPENSO
  ENCERRADO
  CANCELADO
}

enum TarefaStatus {
  PENDENTE
  EM_ANDAMENTO
  CONCLUIDA
  CANCELADA
}

enum TarefaPrioridade {
  BAIXA
  MEDIA
  ALTA
  CRITICA
}

enum SubscriptionStatus {
  TRIAL
  ATIVA
  INADIMPLENTE
  CANCELADA
}

enum InvoiceStatus {
  RASCUNHO
  ABERTA
  PAGA
  VENCIDA
  CANCELADA
}

enum PaymentStatus {
  PENDENTE
  PROCESSANDO
  PAGO
  FALHOU
  ESTORNADO
}

model AreaProcesso {
  id        String   @id @default(cuid())
  tenantId  String?
  slug      String
  nome      String
  descricao String?
  ordem     Int?
  ativo     Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant    Tenant?   @relation(fields: [tenantId], references: [id], onDelete: SetNull)
  processos Processo[]

  @@unique([tenantId, slug])
  @@unique([slug])
  @@index([tenantId])
  @@index([nome])
}

model TipoContrato {
  id        String    @id @default(cuid())
  tenantId  String?
  slug      String
  nome      String
  descricao String?
  ordem     Int?
  ativo     Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  tenant    Tenant?   @relation(fields: [tenantId], references: [id], onDelete: SetNull)
  contratos Contrato[]
  modelos   ModeloContrato[]

  @@unique([tenantId, slug])
  @@unique([slug])
  @@index([tenantId])
  @@index([nome])
}

model CategoriaTarefa {
  id        String   @id @default(cuid())
  tenantId  String?
  slug      String
  nome      String
  descricao String?
  corHex    String?
  ordem     Int?
  ativo     Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant? @relation(fields: [tenantId], references: [id], onDelete: SetNull)
  tarefas Tarefa[]

  @@unique([tenantId, slug])
  @@unique([slug])
  @@index([tenantId])
  @@index([nome])
}

model Tenant {
  id             String                @id @default(cuid())
  name           String
  slug           String                @unique
  domain         String?               @unique
  timezone       String                @default("America/Sao_Paulo")
  status         TenantStatus          @default(ACTIVE)
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
  branding       TenantBranding?
  usuarios       Usuario[]
  advogados      Advogado[]
  clientes       Cliente[]
  processos      Processo[]
  contratos      Contrato[]
  modelosContrato ModeloContrato[]
  tarefas        Tarefa[]
  movimentacoes  MovimentacaoProcesso[]
  documentos     Documento[]
  juizes         Juiz[]
  tribunais      Tribunal[]
  areasProcesso  AreaProcesso[]
  tiposContrato  TipoContrato[]
  categoriasTarefa CategoriaTarefa[]
  subscription   TenantSubscription?
  faturas        Fatura[]
  pagamentos     Pagamento[]
  auditLogs      AuditLog[]
  advogadoClientes AdvogadoCliente[]

  @@index([status])
}

model TenantBranding {
  id                 String   @id @default(cuid())
  tenantId           String   @unique
  tenant             Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  primaryColor       String?
  secondaryColor     String?
  accentColor        String?
  logoUrl            String?
  faviconUrl         String?
  loginBackgroundUrl String?
  emailFromName      String?
  emailFromAddress   String?
  customDomainText   String?
  settings           Json?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

model Usuario {
  id                  String                @id @default(cuid())
  tenantId            String
  tenant              Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  email               String
  passwordHash        String?
  role                UserRole              @default(SECRETARIA)
  firstName           String?
  lastName            String?
  phone               String?
  avatarUrl           String?
  active              Boolean               @default(true)
  lastLoginAt         DateTime?
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  advogado            Advogado?
  tarefas             Tarefa[]              @relation("TarefasResponsaveis")
  tarefasCriadas      Tarefa[]              @relation("TarefasCriadas")
  movimentacoesCriadas MovimentacaoProcesso[] @relation("MovimentacaoCriador")
  documentos          Documento[]           @relation("DocumentoUploader")
  auditLogs           AuditLog[]
  contratosResponsavel Contrato[]           @relation("ContratoResponsavel")
  contratosCriados    Contrato[]            @relation("ContratoCriador")

  @@unique([email, tenantId])
  @@index([role])
}

model Advogado {
  id             String    @id @default(cuid())
  tenantId       String
  usuarioId      String    @unique
  tenant         Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  usuario        Usuario   @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  oabNumero      String?
  oabUf          String?
  especialidades String?
  bio            String?
  telefone       String?
  whatsapp       String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  clientes       AdvogadoCliente[]
  processos      Processo[]            @relation("ProcessoAdvogadoResponsavel")
  contratos      Contrato[]            @relation("ContratoAdvogado")
}

model Cliente {
  id                 String             @id @default(cuid())
  tenantId           String
  tenant             Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tipoPessoa         TipoPessoa
  nome               String
  documento          String?
  email              String?
  telefone           String?
  celular            String?
  dataNascimento     DateTime?
  inscricaoEstadual  String?
  responsavelNome    String?
  responsavelEmail   String?
  responsavelTelefone String?
  endereco           Json?
  observacoes        String?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  processos          Processo[]
  contratos          Contrato[]
  documentos         Documento[]        @relation("DocumentoCliente")
  advogadoClientes   AdvogadoCliente[]
  tarefas            Tarefa[]           @relation("TarefaCliente")

  @@index([nome])
  @@index([documento])
}

model AdvogadoCliente {
  id          String   @id @default(cuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  advogadoId  String
  clienteId   String
  relacionamento String?
  createdAt   DateTime @default(now())

  advogado    Advogado @relation(fields: [advogadoId], references: [id], onDelete: Cascade)
  cliente     Cliente  @relation(fields: [clienteId], references: [id], onDelete: Cascade)

  @@unique([advogadoId, clienteId])
  @@index([clienteId])
}

model Juiz {
  id          String    @id @default(cuid())
  tenantId    String?
  tribunalId  String?
  nome        String
  vara        String?
  comarca     String?
  observacoes String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  tenant      Tenant?   @relation(fields: [tenantId], references: [id], onDelete: SetNull)
  tribunal    Tribunal? @relation(fields: [tribunalId], references: [id], onDelete: SetNull)
  processos   Processo[]

  @@index([nome])
}

model Tribunal {
  id        String    @id @default(cuid())
  tenantId  String?
  nome      String
  sigla     String?
  esfera    String?
  uf        String?
  siteUrl   String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  tenant    Tenant?   @relation(fields: [tenantId], references: [id], onDelete: SetNull)
  processos Processo[]
  juizes    Juiz[]

  @@unique([nome, uf])
}

model Processo {
  id                    String             @id @default(cuid())
  tenantId              String
  numero                String
  titulo                String?
  descricao             String?
  status                ProcessoStatus     @default(RASCUNHO)
  areaId                String?
  classeProcessual      String?
  vara                  String?
  comarca               String?
  foro                  String?
  dataDistribuicao      DateTime?
  segredoJustica        Boolean            @default(false)
  valorCausa            Decimal?           @db.Decimal(14, 2)
  rito                  String?
  clienteId             String
  advogadoResponsavelId String?
  juizId                String?
  tribunalId            String?
  tags                  Json?
  prazoPrincipal        DateTime?
  numeroInterno         String?
  pastaCompartilhadaUrl String?
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt

  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  cliente         Cliente  @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  advogadoResponsavel Advogado? @relation("ProcessoAdvogadoResponsavel", fields: [advogadoResponsavelId], references: [id], onDelete: SetNull)
  juiz            Juiz?    @relation(fields: [juizId], references: [id], onDelete: SetNull)
  tribunal        Tribunal? @relation(fields: [tribunalId], references: [id], onDelete: SetNull)
  area            AreaProcesso?         @relation(fields: [areaId], references: [id], onDelete: SetNull)
  movimentacoes   MovimentacaoProcesso[]
  tarefas         Tarefa[]
  documentos      Documento[]            @relation("DocumentoProcesso")
  contratos       Contrato[]

  @@unique([tenantId, numero])
  @@index([status])
  @@index([clienteId])
  @@index([areaId])
}

model MovimentacaoProcesso {
  id               String             @id @default(cuid())
  tenantId         String
  processoId       String
  titulo           String
  descricao        String?
  tipo             MovimentacaoTipo?
  dataMovimentacao DateTime           @default(now())
  prazo            DateTime?
  criadoPorId      String?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt

  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  processo    Processo @relation(fields: [processoId], references: [id], onDelete: Cascade)
  criadoPor   Usuario? @relation("MovimentacaoCriador", fields: [criadoPorId], references: [id], onDelete: SetNull)
  documentos  Documento[] @relation("MovimentacaoDocumentos")

  @@index([processoId])
  @@index([dataMovimentacao])
}

model Documento {
  id             String                @id @default(cuid())
  tenantId       String
  nome           String
  tipo           String?
  descricao      String?
  url            String
  tamanhoBytes   Int?
  contentType    String?
  processoId     String?
  clienteId      String?
  contratoId     String?
  movimentacaoId String?
  uploadedById   String?
  metadados      Json?
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt

  tenant       Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  processo     Processo?             @relation("DocumentoProcesso", fields: [processoId], references: [id], onDelete: SetNull)
  cliente      Cliente?              @relation("DocumentoCliente", fields: [clienteId], references: [id], onDelete: SetNull)
  contrato     Contrato?             @relation("ContratoDocumentos", fields: [contratoId], references: [id], onDelete: SetNull)
  movimentacao MovimentacaoProcesso? @relation("MovimentacaoDocumentos", fields: [movimentacaoId], references: [id], onDelete: SetNull)
  uploadedBy   Usuario?              @relation("DocumentoUploader", fields: [uploadedById], references: [id], onDelete: SetNull)

  @@index([processoId])
  @@index([clienteId])
}

model Contrato {
  id                    String          @id @default(cuid())
  tenantId              String
  clienteId             String
  modeloId              String?
  advogadoResponsavelId String?
  responsavelUsuarioId  String?
  criadoPorId           String?
  processoId            String?
  titulo                String
  tipoId                String?
  status                ContratoStatus  @default(RASCUNHO)
  valor                 Decimal?        @db.Decimal(14, 2)
  moeda                 String?         @default("BRL")
  dataInicio            DateTime?
  dataFim               DateTime?
  dataAssinatura        DateTime?
  resumo                String?
  arquivoUrl            String?
  observacoes           String?
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt

  tenant              Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  cliente             Cliente         @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  modelo              ModeloContrato? @relation(fields: [modeloId], references: [id], onDelete: SetNull)
  advogadoResponsavel Advogado?       @relation("ContratoAdvogado", fields: [advogadoResponsavelId], references: [id], onDelete: SetNull)
  tipo                TipoContrato?   @relation(fields: [tipoId], references: [id], onDelete: SetNull)
  responsavelUsuario  Usuario?        @relation("ContratoResponsavel", fields: [responsavelUsuarioId], references: [id], onDelete: SetNull)
  criadoPor           Usuario?        @relation("ContratoCriador", fields: [criadoPorId], references: [id], onDelete: SetNull)
  processo            Processo?       @relation(fields: [processoId], references: [id], onDelete: SetNull)
  documentos          Documento[]     @relation("ContratoDocumentos")
  faturas             Fatura[]

  @@index([clienteId])
  @@index([status])
  @@index([tipoId])
}

model ModeloContrato {
  id          String    @id @default(cuid())
  tenantId    String
  tipoId      String?
  nome        String
  descricao   String?
  categoria   String?
  idioma      String?   @default("pt-BR")
  conteudo    String
  variaveis   Json?
  publico     Boolean   @default(false)
  ativo       Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  tenant     Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tipo       TipoContrato? @relation(fields: [tipoId], references: [id], onDelete: SetNull)
  contratos  Contrato[]

  @@index([tipoId])
}

model Tarefa {
  id            String           @id @default(cuid())
  tenantId      String
  titulo        String
  descricao     String?
  status        TarefaStatus     @default(PENDENTE)
  prioridade    TarefaPrioridade @default(MEDIA)
  processoId    String?
  clienteId     String?
  categoriaId   String?
  responsavelId String?
  criadoPorId   String?
  dataLimite    DateTime?
  completedAt   DateTime?
  lembreteEm    DateTime?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  processo    Processo? @relation(fields: [processoId], references: [id], onDelete: SetNull)
  cliente     Cliente?  @relation("TarefaCliente", fields: [clienteId], references: [id], onDelete: SetNull)
  categoria   CategoriaTarefa? @relation(fields: [categoriaId], references: [id], onDelete: SetNull)
  responsavel Usuario?  @relation("TarefasResponsaveis", fields: [responsavelId], references: [id], onDelete: SetNull)
  criadoPor   Usuario?  @relation("TarefasCriadas", fields: [criadoPorId], references: [id], onDelete: SetNull)

  @@index([processoId])
  @@index([responsavelId])
  @@index([status])
  @@index([categoriaId])
}

model Plano {
  id              String             @id @default(cuid())
  nome            String
  slug            String             @unique
  descricao       String?
  valorMensal     Decimal?           @db.Decimal(10, 2)
  valorAnual      Decimal?           @db.Decimal(10, 2)
  moeda           String             @default("BRL")
  limiteUsuarios  Int?
  limiteProcessos Int?
  limiteStorageMb Int?
  recursos        Json?
  ativo           Boolean            @default(true)
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  subscriptions TenantSubscription[]
}

model TenantSubscription {
  id                      String             @id @default(cuid())
  tenantId                String             @unique
  planoId                 String?
  status                  SubscriptionStatus @default(TRIAL)
  dataInicio              DateTime           @default(now())
  dataFim                 DateTime?
  renovaEm                DateTime?
  trialEndsAt             DateTime?
  externalCustomerId      String?
  externalSubscriptionId  String?
  metadata                Json?
  createdAt               DateTime           @default(now())
  updatedAt               DateTime           @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  plano  Plano? @relation(fields: [planoId], references: [id], onDelete: SetNull)
  faturas Fatura[]
}

model Fatura {
  id                String        @id @default(cuid())
  tenantId          String
  subscriptionId    String?
  contratoId        String?
  numero            String?
  descricao         String?
  valor             Decimal        @db.Decimal(12, 2)
  moeda             String         @default("BRL")
  status            InvoiceStatus  @default(RASCUNHO)
  periodoInicio     DateTime?
  periodoFim        DateTime?
  vencimento        DateTime?
  pagoEm            DateTime?
  externalInvoiceId String?
  urlBoleto         String?
  metadata          Json?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  tenant        Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  subscription  TenantSubscription? @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)
  contrato      Contrato?          @relation(fields: [contratoId], references: [id], onDelete: SetNull)
  pagamentos    Pagamento[]

  @@index([tenantId, status])
}

model Pagamento {
  id           String        @id @default(cuid())
  tenantId     String
  faturaId     String
  valor        Decimal       @db.Decimal(12, 2)
  status       PaymentStatus @default(PENDENTE)
  metodo       String?
  transacaoId  String?
  autorizadoEm DateTime?
  confirmadoEm DateTime?
  estornadoEm  DateTime?
  detalhes     Json?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  tenant Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  fatura Fatura   @relation(fields: [faturaId], references: [id], onDelete: Cascade)

  @@index([faturaId])
}

model AuditLog {
  id         String   @id @default(cuid())
  tenantId   String
  usuarioId  String?
  acao       String
  entidade   String
  entidadeId String?
  dados      Json?
  ip         String?
  userAgent  String?
  createdAt  DateTime @default(now())

  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  usuario Usuario? @relation(fields: [usuarioId], references: [id], onDelete: SetNull)

  @@index([tenantId, entidade])
}
