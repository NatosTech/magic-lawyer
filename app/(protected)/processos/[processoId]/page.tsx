"use client";

import { useMemo, useState, useTransition, ReactNode } from "react";
import { useParams, useRouter } from "next/navigation";
import { Card, CardBody, CardHeader } from "@heroui/card";
import { Button } from "@heroui/button";
import { Chip } from "@heroui/chip";
import { Divider } from "@heroui/divider";
import { Spinner } from "@heroui/spinner";
import { Tabs, Tab } from "@heroui/tabs";
import { Input } from "@heroui/input";
import { Textarea } from "@heroui/input";

import {
  ArrowLeft,
  User,
  Mail,
  Phone,
  FileText,
  Building2,
  Briefcase,
  Calendar,
  Scale,
  Clock,
  AlertCircle,
  CheckCircle,
  MapPin,
  DollarSign,
  Gavel,
  Download,
  Eye,
  FileWarning,
  Edit,
  Plus,
  Trash2,
  Layers,
  Flag,
  Landmark,
  Link2,
  Info,
  Users,
  FileSignature,
} from "lucide-react";
import type { LucideIcon } from "lucide-react";
import Link from "next/link";
import { toast } from "@/lib/toast";

import {
  useProcessoDetalhado,
  useDocumentosProcesso,
  useEventosProcesso,
} from "@/app/hooks/use-processos";
import { useProcuracoesDisponiveis } from "@/app/hooks/use-clientes";
import { title } from "@/components/primitives";
import {
  ProcessoStatus,
  ProcessoPolo,
  ProcessoPrazoStatus,
  ProcessoFase,
  ProcessoGrau,
} from "@/generated/prisma";
import { DateUtils } from "@/app/lib/date-utils";
import {
  createProcessoParte,
  deleteProcessoParte,
  createProcessoPrazo,
  updateProcessoPrazo,
  deleteProcessoPrazo,
  linkProcuracaoAoProcesso,
  unlinkProcuracaoDoProcesso,
} from "@/app/actions/processos";
import JuizModal from "@/components/juiz-modal";
import { Select, SelectItem } from "@heroui/react";
import { DateInput } from "@/components/ui/date-input";

const parteFormInitial: {
  tipoPolo: ProcessoPolo;
  nome: string;
  documento: string;
  email: string;
  telefone: string;
  papel: string;
  observacoes: string;
} = {
  tipoPolo: ProcessoPolo.AUTOR,
  nome: "",
  documento: "",
  email: "",
  telefone: "",
  papel: "",
  observacoes: "",
};

const prazoFormInitial = {
  titulo: "",
  dataVencimento: "",
  descricao: "",
  fundamentoLegal: "",
};

interface InfoItemProps {
  label: string;
  icon: LucideIcon;
  children: ReactNode;
  href?: string;
  external?: boolean;
  highlight?: boolean;
}

interface QuickAction {
  label: string;
  href: string;
  icon: LucideIcon;
  tab: string;
  count?: number;
}

const InfoItem = ({
  label,
  icon: Icon,
  children,
  href,
  external = false,
  highlight = false,
}: InfoItemProps) => {
  const content = (
    <div
      className={`flex items-center gap-2 text-sm font-medium ${highlight ? "text-warning-600" : "text-default-700"}`}
    >
      <Icon
        className={`h-4 w-4 ${highlight ? "text-warning" : "text-default-400"}`}
      />
      <span className="truncate">{children}</span>
    </div>
  );

  const value = href ? (
    external ? (
      <a
        className="block text-primary underline decoration-dotted decoration-primary/40 hover:decoration-solid"
        href={href}
        rel="noopener noreferrer"
        target="_blank"
      >
        {content}
      </a>
    ) : (
      <Link
        className="block text-primary underline decoration-dotted decoration-primary/40 hover:decoration-solid"
        href={href}
      >
        {content}
      </Link>
    )
  ) : (
    content
  );

  return (
    <div className="rounded-2xl border border-default-200/70 bg-default-50/60 p-3">
      <p className="text-[11px] font-semibold uppercase tracking-[0.3em] text-default-400">
        {label}
      </p>
      <div className="mt-2">{value}</div>
    </div>
  );
};

const getStatusColor = (status: ProcessoStatus) => {
  switch (status) {
    case ProcessoStatus.EM_ANDAMENTO:
      return "primary";
    case ProcessoStatus.ENCERRADO:
      return "success";
    case ProcessoStatus.ARQUIVADO:
      return "default";
    case ProcessoStatus.SUSPENSO:
      return "warning";
    case ProcessoStatus.RASCUNHO:
    default:
      return "default";
  }
};

const getStatusLabel = (status: ProcessoStatus) => {
  switch (status) {
    case ProcessoStatus.EM_ANDAMENTO:
      return "Em Andamento";
    case ProcessoStatus.ENCERRADO:
      return "Encerrado";
    case ProcessoStatus.ARQUIVADO:
      return "Arquivado";
    case ProcessoStatus.SUSPENSO:
      return "Suspenso";
    case ProcessoStatus.RASCUNHO:
    default:
      return "Rascunho";
  }
};

const getStatusIcon = (status: ProcessoStatus) => {
  switch (status) {
    case ProcessoStatus.EM_ANDAMENTO:
      return <Clock className="h-4 w-4" />;
    case ProcessoStatus.ENCERRADO:
      return <CheckCircle className="h-4 w-4" />;
    case ProcessoStatus.ARQUIVADO:
      return <FileText className="h-4 w-4" />;
    case ProcessoStatus.SUSPENSO:
      return <AlertCircle className="h-4 w-4" />;
    case ProcessoStatus.RASCUNHO:
    default:
      return <FileWarning className="h-4 w-4" />;
  }
};

const getFaseLabel = (fase: ProcessoFase) => {
  switch (fase) {
    case ProcessoFase.PETICAO_INICIAL:
      return "Petição Inicial";
    case ProcessoFase.CITACAO:
      return "Citação";
    case ProcessoFase.INSTRUCAO:
      return "Instrução";
    case ProcessoFase.SENTENCA:
      return "Sentença";
    case ProcessoFase.RECURSO:
      return "Recurso";
    case ProcessoFase.EXECUCAO:
      return "Execução";
    default:
      return fase;
  }
};

const getGrauLabel = (grau: ProcessoGrau) => {
  switch (grau) {
    case ProcessoGrau.PRIMEIRO:
      return "1º Grau";
    case ProcessoGrau.SEGUNDO:
      return "2º Grau";
    case ProcessoGrau.SUPERIOR:
      return "Tribunal Superior";
    default:
      return grau;
  }
};

const getPrazoStatusColor = (status: ProcessoPrazoStatus) => {
  switch (status) {
    case ProcessoPrazoStatus.ABERTO:
      return "primary";
    case ProcessoPrazoStatus.CONCLUIDO:
      return "success";
    case ProcessoPrazoStatus.PRORROGADO:
      return "warning";
    case ProcessoPrazoStatus.CANCELADO:
      return "default";
    default:
      return "default";
  }
};

const getPrazoStatusLabel = (status: ProcessoPrazoStatus) => {
  switch (status) {
    case ProcessoPrazoStatus.ABERTO:
      return "Aberto";
    case ProcessoPrazoStatus.CONCLUIDO:
      return "Concluído";
    case ProcessoPrazoStatus.PRORROGADO:
      return "Prorrogado";
    case ProcessoPrazoStatus.CANCELADO:
      return "Cancelado";
    default:
      return status;
  }
};

export default function ProcessoDetalhesPage() {
  const params = useParams();
  const router = useRouter();
  const processoId = params.processoId as string;

  const { processo, isCliente, isLoading, isError, mutate } =
    useProcessoDetalhado(processoId);
  const { documentos, isLoading: isLoadingDocs } =
    useDocumentosProcesso(processoId);
  const { eventos, isLoading: isLoadingEventos } =
    useEventosProcesso(processoId);
  const { procuracoes: procuracoesDisponiveis } = useProcuracoesDisponiveis(
    processo?.cliente?.id ?? null,
  );

  const polos = useMemo(() => Object.values(ProcessoPolo), []);
  const fases = useMemo(() => Object.values(ProcessoFase), []);
  const graus = useMemo(() => Object.values(ProcessoGrau), []);

  const [parteForm, setParteForm] = useState(parteFormInitial);
  const [prazoForm, setPrazoForm] = useState(prazoFormInitial);
  const [selectedProcuracaoId, setSelectedProcuracaoId] = useState<string>("");
  const [parteActionId, setParteActionId] = useState<string | null>(null);
  const [prazoActionId, setPrazoActionId] = useState<string | null>(null);
  const [procuracaoActionId, setProcuracaoActionId] = useState<string | null>(
    null,
  );
  const [isCreatingParte, setIsCreatingParte] = useState(false);
  const [isCreatingPrazo, setIsCreatingPrazo] = useState(false);
  const [isLinkingProcuracao, setIsLinkingProcuracao] = useState(false);
  const [isJuizModalOpen, setIsJuizModalOpen] = useState(false);
  const [abaAtual, setAbaAtual] = useState<string>("informacoes");
  const [, startTransition] = useTransition();

  const prazosOrdenados = useMemo(() => {
    if (!processo?.prazos) return [];

    return [...processo.prazos].sort((a, b) => {
      const diff =
        new Date(a.dataVencimento).getTime() -
        new Date(b.dataVencimento).getTime();

      return diff;
    });
  }, [processo?.prazos]);

  const partesOrdenadas = useMemo(() => {
    if (!processo?.partes) return [];

    return [...processo.partes].sort((a, b) => {
      const poloDiff = a.tipoPolo.localeCompare(b.tipoPolo);

      if (poloDiff !== 0) return poloDiff;

      return a.nome.localeCompare(b.nome);
    });
  }, [processo?.partes]);

  const vinculoIds = useMemo(() => {
    if (!processo?.procuracoesVinculadas) return [] as string[];

    return processo.procuracoesVinculadas.map((p) => p.procuracao.id);
  }, [processo?.procuracoesVinculadas]);

  const procuracoesDisponiveisFiltradas = useMemo(() => {
    if (!procuracoesDisponiveis) return [] as any[];

    if (vinculoIds.length === 0) return procuracoesDisponiveis;

    return procuracoesDisponiveis.filter(
      (proc: any) => !vinculoIds.includes(proc.id),
    );
  }, [procuracoesDisponiveis, vinculoIds]);

  if (isLoading) {
    return (
      <div className="flex min-h-[400px] items-center justify-center">
        <Spinner label="Carregando processo..." size="lg" />
      </div>
    );
  }

  if (isError || !processo) {
    return (
      <div className="flex min-h-[400px] flex-col items-center justify-center gap-4">
        <AlertCircle className="h-12 w-12 text-danger" />
        <p className="text-lg font-semibold text-danger">
          Erro ao carregar processo
        </p>
        <Button color="primary" onPress={() => router.back()}>
          Voltar
        </Button>
      </div>
    );
  }

  const faseLabel = processo.fase ? getFaseLabel(processo.fase) : null;
  const grauLabel = processo.grau ? getGrauLabel(processo.grau) : null;
  const pastaUrl = processo.pastaCompartilhadaUrl;
  const clienteLink = processo.cliente?.id
    ? `/clientes/${processo.cliente.id}`
    : undefined;
  const advogadoLink = processo.advogadoResponsavel?.id
    ? `/advogados/${processo.advogadoResponsavel.id}`
    : undefined;

  const quickActions: QuickAction[] = [
    {
      label: "Informações",
      href: "#processo-informacoes",
      icon: Info,
      tab: "informacoes",
    },
    {
      label: "Prazos",
      href: "#processo-prazos",
      icon: Clock,
      tab: "prazos",
      count: prazosOrdenados.length,
    },
    {
      label: "Documentos",
      href: "#processo-documentos",
      icon: FileText,
      tab: "documentos",
      count: processo._count?.documentos ?? 0,
    },
    {
      label: "Eventos",
      href: "#processo-eventos",
      icon: Calendar,
      tab: "eventos",
      count: processo._count?.eventos ?? 0,
    },
    {
      label: "Procurações",
      href: "#processo-procuracoes",
      icon: FileSignature,
      tab: "procuracoes",
      count: processo.procuracoesVinculadas.length,
    },
  ];

  const handleQuickAction = (action: QuickAction) => {
    setAbaAtual(action.tab);
    setTimeout(() => {
      const section = document.querySelector(action.href);
      if (section) {
        section.scrollIntoView({ behavior: "smooth", block: "start" });
      }
    }, 80);
  };

  const handleRefresh = () =>
    startTransition(() => {
      mutate();
    });

  const handleCreateParte = async () => {
    if (!parteForm.nome.trim()) {
      toast.error("Informe o nome da parte");

      return;
    }

    setIsCreatingParte(true);
    try {
      const result = await createProcessoParte(processoId, {
        tipoPolo: parteForm.tipoPolo,
        nome: parteForm.nome.trim(),
        documento: parteForm.documento.trim() || undefined,
        email: parteForm.email.trim() || undefined,
        telefone: parteForm.telefone.trim() || undefined,
        papel: parteForm.papel.trim() || undefined,
        observacoes: parteForm.observacoes.trim() || undefined,
      });

      if (result.success) {
        toast.success("Parte adicionada");
        setParteForm(parteFormInitial);
        handleRefresh();
      } else {
        toast.error(result.error || "Erro ao criar parte");
      }
    } catch (error) {
      toast.error("Erro ao criar parte");
    } finally {
      setIsCreatingParte(false);
    }
  };

  const handleDeleteParte = async (parteId: string) => {
    setParteActionId(parteId);
    try {
      const result = await deleteProcessoParte(parteId);

      if (result.success) {
        toast.success("Parte removida");
        handleRefresh();
      } else {
        toast.error(result.error || "Erro ao remover parte");
      }
    } catch (error) {
      toast.error("Erro ao remover parte");
    } finally {
      setParteActionId(null);
    }
  };

  const handleCreatePrazo = async () => {
    if (!prazoForm.titulo.trim()) {
      toast.error("Informe o título do prazo");

      return;
    }

    if (!prazoForm.dataVencimento) {
      toast.error("Informe a data de vencimento");

      return;
    }

    setIsCreatingPrazo(true);
    try {
      const result = await createProcessoPrazo(processoId, {
        titulo: prazoForm.titulo.trim(),
        dataVencimento: prazoForm.dataVencimento,
        descricao: prazoForm.descricao.trim() || undefined,
        fundamentoLegal: prazoForm.fundamentoLegal.trim() || undefined,
      });

      if (result.success) {
        toast.success("Prazo criado");
        setPrazoForm(prazoFormInitial);
        handleRefresh();
      } else {
        toast.error(result.error || "Erro ao criar prazo");
      }
    } catch (error) {
      toast.error("Erro ao criar prazo");
    } finally {
      setIsCreatingPrazo(false);
    }
  };

  const handlePrazoStatus = async (
    prazoId: string,
    status: ProcessoPrazoStatus,
  ) => {
    setPrazoActionId(prazoId);
    try {
      const result = await updateProcessoPrazo(prazoId, {
        status,
        dataCumprimento:
          status === ProcessoPrazoStatus.CONCLUIDO ? new Date() : null,
      });

      if (result.success) {
        toast.success("Prazo atualizado");
        handleRefresh();
      } else {
        toast.error(result.error || "Erro ao atualizar prazo");
      }
    } catch (error) {
      toast.error("Erro ao atualizar prazo");
    } finally {
      setPrazoActionId(null);
    }
  };

  const handleDeletePrazo = async (prazoId: string) => {
    setPrazoActionId(prazoId);
    try {
      const result = await deleteProcessoPrazo(prazoId);

      if (result.success) {
        toast.success("Prazo removido");
        handleRefresh();
      } else {
        toast.error(result.error || "Erro ao remover prazo");
      }
    } catch (error) {
      toast.error("Erro ao remover prazo");
    } finally {
      setPrazoActionId(null);
    }
  };

  const handleLinkProcuracao = async () => {
    if (!selectedProcuracaoId) {
      toast.error("Selecione uma procuração");

      return;
    }

    setIsLinkingProcuracao(true);
    try {
      const result = await linkProcuracaoAoProcesso(
        processoId,
        selectedProcuracaoId,
      );

      if (result.success) {
        toast.success("Procuração vinculada");
        setSelectedProcuracaoId("");
        handleRefresh();
      } else {
        toast.error(result.error || "Erro ao vincular procuração");
      }
    } catch (error) {
      toast.error("Erro ao vincular procuração");
    } finally {
      setIsLinkingProcuracao(false);
    }
  };

  const handleUnlinkProcuracao = async (procuracaoId: string) => {
    setProcuracaoActionId(procuracaoId);
    try {
      const result = await unlinkProcuracaoDoProcesso(processoId, procuracaoId);

      if (result.success) {
        toast.success("Procuração desvinculada");
        handleRefresh();
      } else {
        toast.error(result.error || "Erro ao desvincular procuração");
      }
    } catch (error) {
      toast.error("Erro ao desvincular procuração");
    } finally {
      setProcuracaoActionId(null);
    }
  };

  return (
    <div className="space-y-6">
      <div className="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
        <Button
          startContent={<ArrowLeft className="h-4 w-4" />}
          variant="light"
          onPress={() => router.back()}
        >
          Voltar
        </Button>
        {!isCliente && (
          <div className="flex gap-2">
            <Button
              as={Link}
              href={`/processos/${processoId}/editar`}
              startContent={<Edit className="h-4 w-4" />}
              variant="bordered"
            >
              Editar Processo
            </Button>
          </div>
        )}
      </div>

      <Card className="border border-default-200">
        <CardHeader className="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
          <div className="flex flex-wrap items-start gap-4">
            <div className="rounded-2xl bg-primary/10 p-3">
              <Scale className="h-6 w-6 text-primary" />
            </div>
            <div>
              <p className="text-xs font-semibold uppercase tracking-[0.35em] text-default-400">
                Processo
              </p>
              <h1 className={title({ size: "md" })}>{processo.numero}</h1>
              {processo.numeroCnj && processo.numeroCnj !== processo.numero ? (
                <p className="text-xs text-default-500">CNJ: {processo.numeroCnj}</p>
              ) : null}
              {processo.titulo && (
                <p className="mt-1 text-sm text-default-500">{processo.titulo}</p>
              )}
            </div>
          </div>
          <div className="flex flex-wrap gap-2">
            <Chip
              color={getStatusColor(processo.status)}
              size="lg"
              startContent={getStatusIcon(processo.status)}
              variant="flat"
            >
              {getStatusLabel(processo.status)}
            </Chip>
            {faseLabel && (
              <Chip
                color="secondary"
                size="lg"
                startContent={<Flag className="h-3 w-3" />}
                variant="flat"
              >
                {faseLabel}
              </Chip>
            )}
            {grauLabel && (
              <Chip
                color="default"
                size="lg"
                startContent={<Layers className="h-3 w-3" />}
                variant="flat"
              >
                {grauLabel}
              </Chip>
            )}
            {processo.segredoJustica && (
              <Chip color="warning" size="lg" variant="flat">
                Segredo de Justiça
              </Chip>
            )}
          </div>
        </CardHeader>
        <Divider />
        <CardBody className="space-y-6">
          <div className="grid gap-6 lg:grid-cols-[2fr,1fr]">
            <div className="grid gap-3 sm:grid-cols-2">
              {processo.area && (
                <InfoItem icon={Briefcase} label="Área de atuação">
                  {processo.area.nome}
                </InfoItem>
              )}
              {processo.cliente && (
                <InfoItem
                  icon={
                    processo.cliente.tipoPessoa === "JURIDICA"
                      ? Building2
                      : User
                  }
                  label="Cliente"
                  href={clienteLink}
                >
                  {processo.cliente.nome}
                </InfoItem>
              )}
              {processo.advogadoResponsavel && (
                <InfoItem
                  icon={User}
                  label="Advogado responsável"
                  href={advogadoLink}
                >
                  {processo.advogadoResponsavel.usuario.firstName}{" "}
                  {processo.advogadoResponsavel.usuario.lastName}
                </InfoItem>
              )}
              {processo.vara && (
                <InfoItem icon={Gavel} label="Vara">
                  {processo.vara}
                </InfoItem>
              )}
              {processo.comarca && (
                <InfoItem icon={MapPin} label="Comarca">
                  {processo.comarca}
                </InfoItem>
              )}
              {processo.valorCausa && (
                <InfoItem icon={DollarSign} label="Valor da causa">
                  {Number(processo.valorCausa).toLocaleString("pt-BR", {
                    style: "currency",
                    currency: "BRL",
                  })}
                </InfoItem>
              )}
              {processo.dataDistribuicao && (
                <InfoItem icon={Calendar} label="Distribuído em">
                  {DateUtils.formatDate(processo.dataDistribuicao)}
                </InfoItem>
              )}
              {processo.prazoPrincipal && (
                <InfoItem
                  icon={Clock}
                  label="Prazo principal"
                  highlight
                >
                  {DateUtils.formatDate(processo.prazoPrincipal)}
                </InfoItem>
              )}
              {processo.orgaoJulgador && (
                <InfoItem icon={Landmark} label="Órgão julgador">
                  {processo.orgaoJulgador}
                </InfoItem>
              )}
              {pastaUrl && (
                <InfoItem
                  external
                  href={pastaUrl}
                  icon={Link2}
                  label="Pasta compartilhada"
                >
                  Abrir arquivos
                </InfoItem>
              )}
            </div>
            <div className="space-y-3 rounded-2xl border border-default-200/80 bg-default-50/60 p-4">
              <div>
                <p className="text-[11px] font-semibold uppercase tracking-[0.35em] text-default-400">
                  Atalhos rápidos
                </p>
                <p className="text-xs text-default-500">
                  Vá direto para documentos, eventos, prazos e vínculos.
                </p>
              </div>
              <div className="grid gap-2">
                {quickActions.map((action) => (
                  <Button
                    key={action.href}
                    color="primary"
                    radius="md"
                    size="sm"
                    variant="flat"
                    className="justify-between"
                    onPress={() => handleQuickAction(action)}
                  >
                    <span className="flex items-center gap-2">
                      <action.icon className="h-4 w-4" />
                      {action.label}
                    </span>
                    {typeof action.count === "number" ? (
                      <Chip size="sm" variant="flat">
                        {action.count}
                      </Chip>
                    ) : null}
                  </Button>
                ))}
              </div>
            </div>
          </div>
        </CardBody>
      </Card>

      <Tabs
        aria-label="Informações do Processo"
        color="primary"
        selectedKey={abaAtual}
        variant="underlined"
        onSelectionChange={(key) => setAbaAtual(key as string)}
      >
        <Tab
          key="informacoes"
          title={
            <div className="flex items-center gap-2">
              <Info className="h-4 w-4" />
              <span>Informações</span>
            </div>
          }
        >
          <div
            className="mt-4 space-y-4 scroll-mt-24"
            id="processo-informacoes"
          >
            {!isCliente && (
              <div className="flex justify-end">
                <Button
                  as={Link}
                  color="primary"
                  href={`/procuracoes/novo?clienteId=${processo.cliente.id}`}
                  size="sm"
                  startContent={<Plus className="h-3 w-3" />}
                >
                  Nova procuração
                </Button>
              </div>
            )}

            <Card className="border border-default-200">
              <CardHeader>
                <h3 className="text-lg font-semibold">Dados gerais</h3>
              </CardHeader>
              <Divider />
              <CardBody className="space-y-4">
                <div className="grid gap-4 md:grid-cols-2">
                  {processo.descricao && (
                    <div className="md:col-span-2">
                      <p className="text-xs font-semibold uppercase text-default-400">
                        Descrição
                      </p>
                      <p className="mt-1 text-sm text-default-600">
                        {processo.descricao}
                      </p>
                    </div>
                  )}

                  {processo.classeProcessual && (
                    <div>
                      <p className="text-xs font-semibold uppercase text-default-400">
                        Classe Processual
                      </p>
                      <p className="mt-1 text-sm text-default-600">
                        {processo.classeProcessual}
                      </p>
                    </div>
                  )}

                  {processo.rito && (
                    <div>
                      <p className="text-xs font-semibold uppercase text-default-400">
                        Rito
                      </p>
                      <p className="mt-1 text-sm text-default-600">
                        {processo.rito}
                      </p>
                    </div>
                  )}

                  {processo.numeroInterno && (
                    <div>
                      <p className="text-xs font-semibold uppercase text-default-400">
                        Número interno
                      </p>
                      <p className="mt-1 text-sm text-default-600">
                        {processo.numeroInterno}
                      </p>
                    </div>
                  )}

                  {processo.foro && (
                    <div>
                      <p className="text-xs font-semibold uppercase text-default-400">
                        Foro
                      </p>
                      <p className="mt-1 text-sm text-default-600">
                        {processo.foro}
                      </p>
                    </div>
                  )}
                </div>

                {/* Informações do Juiz */}
                {processo.juiz && (
                  <div className="border-t border-default-200 pt-4">
                    <div className="flex items-center justify-between mb-3">
                      <h4 className="text-sm font-semibold text-default-700 flex items-center gap-2">
                        <Gavel className="h-4 w-4" />
                        Juiz Relator
                      </h4>
                      <Button
                        color="primary"
                        size="sm"
                        startContent={<Gavel className="h-4 w-4" />}
                        variant="bordered"
                        onPress={() => setIsJuizModalOpen(true)}
                      >
                        Ver Mais Informações
                      </Button>
                    </div>
                    <div className="grid gap-3 md:grid-cols-2">
                      <div>
                        <p className="text-xs font-semibold uppercase text-default-400">
                          Nome
                        </p>
                        <p className="mt-1 text-sm text-default-600">
                          {processo.juiz.nomeCompleto || processo.juiz.nome}
                        </p>
                      </div>

                      {processo.juiz.vara && (
                        <div>
                          <p className="text-xs font-semibold uppercase text-default-400">
                            Vara
                          </p>
                          <p className="mt-1 text-sm text-default-600">
                            {processo.juiz.vara}
                          </p>
                        </div>
                      )}

                      {processo.juiz.comarca && (
                        <div>
                          <p className="text-xs font-semibold uppercase text-default-400">
                            Comarca
                          </p>
                          <p className="mt-1 text-sm text-default-600">
                            {processo.juiz.comarca}
                          </p>
                        </div>
                      )}

                      {processo.juiz.nivel && (
                        <div>
                          <p className="text-xs font-semibold uppercase text-default-400">
                            Nível
                          </p>
                          <p className="mt-1 text-sm text-default-600">
                            {processo.juiz.nivel.replace("_", " ")}
                          </p>
                        </div>
                      )}

                      {processo.juiz.especialidades &&
                        processo.juiz.especialidades.length > 0 && (
                          <div className="md:col-span-2">
                            <p className="text-xs font-semibold uppercase text-default-400">
                              Especialidades
                            </p>
                            <div className="mt-1 flex flex-wrap gap-1">
                              {processo.juiz.especialidades.map(
                                (especialidade: string) => (
                                  <Chip
                                    key={especialidade}
                                    color="secondary"
                                    size="sm"
                                    variant="flat"
                                  >
                                    {especialidade}
                                  </Chip>
                                ),
                              )}
                            </div>
                          </div>
                        )}
                    </div>
                  </div>
                )}

                {/* Informações do Tribunal */}
                {(processo.tribunal ||
                  (processo.juiz && processo.juiz.tribunal)) && (
                  <div className="border-t border-default-200 pt-4">
                    <h4 className="text-sm font-semibold text-default-700 mb-3 flex items-center gap-2">
                      <Landmark className="h-4 w-4" />
                      Tribunal
                    </h4>
                    <div className="grid gap-3 md:grid-cols-2">
                      {(() => {
                        const tribunal =
                          processo.tribunal || processo.juiz?.tribunal;

                        if (!tribunal) return null;

                        return (
                          <>
                            <div>
                              <p className="text-xs font-semibold uppercase text-default-400">
                                Nome
                              </p>
                              <p className="mt-1 text-sm text-default-600">
                                {tribunal.nome}
                              </p>
                            </div>

                            {tribunal.sigla && (
                              <div>
                                <p className="text-xs font-semibold uppercase text-default-400">
                                  Sigla
                                </p>
                                <p className="mt-1 text-sm text-default-600">
                                  {tribunal.sigla}
                                </p>
                              </div>
                            )}

                            {tribunal.esfera && (
                              <div>
                                <p className="text-xs font-semibold uppercase text-default-400">
                                  Esfera
                                </p>
                                <p className="mt-1 text-sm text-default-600">
                                  {tribunal.esfera}
                                </p>
                              </div>
                            )}

                            {tribunal.uf && (
                              <div>
                                <p className="text-xs font-semibold uppercase text-default-400">
                                  UF
                                </p>
                                <p className="mt-1 text-sm text-default-600">
                                  {tribunal.uf}
                                </p>
                              </div>
                            )}

                            {tribunal.siteUrl && (
                              <div className="md:col-span-2">
                                <p className="text-xs font-semibold uppercase text-default-400">
                                  Site
                                </p>
                                <a
                                  className="mt-1 text-sm text-primary hover:underline"
                                  href={tribunal.siteUrl}
                                  rel="noopener noreferrer"
                                  target="_blank"
                                >
                                  {tribunal.siteUrl}
                                </a>
                              </div>
                            )}
                          </>
                        );
                      })()}
                    </div>
                  </div>
                )}
              </CardBody>
            </Card>
          </div>
        </Tab>

        <Tab
          key="partes"
          title={
            <div className="flex items-center gap-2">
              <Users className="h-4 w-4" />
              <span>Partes</span>
              {processo.partes.length > 0 && (
                <Chip size="sm" variant="flat">
                  {processo.partes.length}
                </Chip>
              )}
            </div>
          }
        >
          <div
            className="mt-4 space-y-4 scroll-mt-24"
            id="processo-prazos"
          >
            <Card className="border border-default-200">
              <CardHeader>
                <div className="flex items-center justify-between w-full">
                  <h3 className="text-lg font-semibold">Partes vinculadas</h3>
                  <Chip variant="flat">{processo.partes.length}</Chip>
                </div>
              </CardHeader>
              <Divider />
              <CardBody className="space-y-3">
                {partesOrdenadas.length === 0 ? (
                  <p className="text-sm text-default-500">
                    Nenhuma parte cadastrada.
                  </p>
                ) : (
                  partesOrdenadas.map((parte) => (
                    <Card key={parte.id} className="border border-default-200">
                      <CardBody className="gap-2">
                        <div className="flex items-start justify-between gap-3">
                          <div className="space-y-1">
                            <div className="flex items-center gap-2 flex-wrap">
                              <Chip size="sm" variant="flat">
                                {parte.tipoPolo}
                              </Chip>
                              <span className="text-sm font-semibold text-default-700">
                                {parte.nome}
                              </span>
                              {parte.papel && (
                                <span className="text-xs text-default-400">
                                  {parte.papel}
                                </span>
                              )}
                            </div>
                            <div className="flex flex-wrap gap-3 text-xs text-default-500">
                              {parte.documento && (
                                <span className="flex items-center gap-1">
                                  <FileText className="h-3 w-3" />
                                  {parte.documento}
                                </span>
                              )}
                              {parte.email && (
                                <span className="flex items-center gap-1">
                                  <Mail className="h-3 w-3" />
                                  {parte.email}
                                </span>
                              )}
                              {parte.telefone && (
                                <span className="flex items-center gap-1">
                                  <Phone className="h-3 w-3" />
                                  {parte.telefone}
                                </span>
                              )}
                            </div>
                            {parte.observacoes && (
                              <p className="text-xs text-default-500">
                                {parte.observacoes}
                              </p>
                            )}
                          </div>
                          {!isCliente && (
                            <Button
                              isIconOnly
                              color="danger"
                              disabled={parteActionId === parte.id}
                              isLoading={parteActionId === parte.id}
                              variant="light"
                              onPress={() => handleDeleteParte(parte.id)}
                            >
                              <Trash2 className="h-4 w-4" />
                            </Button>
                          )}
                        </div>
                      </CardBody>
                    </Card>
                  ))
                )}
              </CardBody>
            </Card>

            {!isCliente && (
              <Card className="border border-default-200">
                <CardHeader>
                  <h3 className="text-lg font-semibold flex items-center gap-2">
                    <Plus className="h-4 w-4" /> Nova Parte
                  </h3>
                </CardHeader>
                <Divider />
                <CardBody className="space-y-4">
                  <Select
                    label="Tipo de polo"
                    selectedKeys={[parteForm.tipoPolo]}
                    onSelectionChange={(keys) => {
                      const key = Array.from(keys)[0] as
                        | ProcessoPolo
                        | undefined;

                      setParteForm((prev) => ({
                        ...prev,
                        tipoPolo: key ?? prev.tipoPolo,
                      }));
                    }}
                  >
                    {polos.map((polo) => (
                      <SelectItem key={polo} textValue={polo}>{polo}</SelectItem>
                    ))}
                  </Select>

                  <Input
                    label="Nome"
                    placeholder="Nome completo da parte"
                    value={parteForm.nome}
                    onValueChange={(value) =>
                      setParteForm((prev) => ({ ...prev, nome: value }))
                    }
                  />

                  <div className="grid gap-4 md:grid-cols-2">
                    <Input
                      label="Documento"
                      value={parteForm.documento}
                      onValueChange={(value) =>
                        setParteForm((prev) => ({ ...prev, documento: value }))
                      }
                    />
                    <Input
                      label="Telefone"
                      value={parteForm.telefone}
                      onValueChange={(value) =>
                        setParteForm((prev) => ({ ...prev, telefone: value }))
                      }
                    />
                  </div>

                  <Input
                    label="E-mail"
                    value={parteForm.email}
                    onValueChange={(value) =>
                      setParteForm((prev) => ({ ...prev, email: value }))
                    }
                  />
                  <Input
                    label="Papel no processo"
                    value={parteForm.papel}
                    onValueChange={(value) =>
                      setParteForm((prev) => ({ ...prev, papel: value }))
                    }
                  />
                  <Textarea
                    label="Observações"
                    minRows={2}
                    value={parteForm.observacoes}
                    onValueChange={(value) =>
                      setParteForm((prev) => ({ ...prev, observacoes: value }))
                    }
                  />

                  <div className="flex justify-end">
                    <Button
                      color="primary"
                      isLoading={isCreatingParte}
                      startContent={<Plus className="h-4 w-4" />}
                      onPress={handleCreateParte}
                    >
                      Adicionar parte
                    </Button>
                  </div>
                </CardBody>
              </Card>
            )}
          </div>
        </Tab>

        <Tab
          key="prazos"
          title={
            <div className="flex items-center gap-2">
              <Clock className="h-4 w-4" />
              <span>Prazos</span>
              {prazosOrdenados.length > 0 && (
                <Chip size="sm" variant="flat">
                  {prazosOrdenados.length}
                </Chip>
              )}
            </div>
          }
        >
          <div
            className="mt-4 space-y-4 scroll-mt-24"
            id="processo-documentos"
          >
            <Card className="border border-default-200">
              <CardHeader>
                <div className="flex items-center justify-between w-full">
                  <h3 className="text-lg font-semibold">Prazos do processo</h3>
                  <Chip variant="flat">{prazosOrdenados.length}</Chip>
                </div>
              </CardHeader>
              <Divider />
              <CardBody className="space-y-3">
                {prazosOrdenados.length === 0 ? (
                  <p className="text-sm text-default-500">
                    Nenhum prazo cadastrado.
                  </p>
                ) : (
                  prazosOrdenados.map((prazo) => {
                    const vencimento = DateUtils.formatDate(
                      prazo.dataVencimento,
                    );
                    const diasRestantes = DateUtils.diffInDays(
                      prazo.dataVencimento,
                      new Date(),
                    );
                    const isVencido =
                      diasRestantes < 0 &&
                      prazo.status !== ProcessoPrazoStatus.CONCLUIDO;

                    return (
                      <Card
                        key={prazo.id}
                        className="border border-default-200"
                      >
                        <CardBody className="gap-3">
                          <div className="flex items-start justify-between gap-3">
                            <div className="space-y-1">
                              <div className="flex items-center gap-2 flex-wrap">
                                <Chip
                                  color={getPrazoStatusColor(prazo.status)}
                                  size="sm"
                                  variant="flat"
                                >
                                  {getPrazoStatusLabel(prazo.status)}
                                </Chip>
                                <span className="text-sm font-semibold text-default-700">
                                  {prazo.titulo}
                                </span>
                                <span
                                  className={`text-xs ${isVencido ? "text-danger" : "text-default-400"}`}
                                >
                                  Vencimento: {vencimento}
                                  {diasRestantes === 0 && " (vence hoje)"}
                                  {diasRestantes > 0 &&
                                    ` (em ${diasRestantes} dia${diasRestantes === 1 ? "" : "s"})`}
                                  {diasRestantes < 0 &&
                                    ` (${Math.abs(diasRestantes)} dia${Math.abs(diasRestantes) === 1 ? "" : "s"} em atraso)`}
                                </span>
                              </div>
                              {prazo.descricao && (
                                <p className="text-xs text-default-500">
                                  {prazo.descricao}
                                </p>
                              )}
                              {prazo.fundamentoLegal && (
                                <p className="text-xs text-default-500">
                                  <strong>Fundamento:</strong>{" "}
                                  {prazo.fundamentoLegal}
                                </p>
                              )}
                              {prazo.responsavel && (
                                <p className="text-xs text-default-500">
                                  <strong>Responsável:</strong>{" "}
                                  {prazo.responsavel.firstName}{" "}
                                  {prazo.responsavel.lastName}
                                </p>
                              )}
                            </div>
                            {!isCliente && (
                              <div className="flex gap-2">
                                {prazo.status !==
                                  ProcessoPrazoStatus.CONCLUIDO && (
                                  <Button
                                    color="success"
                                    isLoading={prazoActionId === prazo.id}
                                    size="sm"
                                    startContent={
                                      <CheckCircle className="h-3 w-3" />
                                    }
                                    variant="flat"
                                    onPress={() =>
                                      handlePrazoStatus(
                                        prazo.id,
                                        ProcessoPrazoStatus.CONCLUIDO,
                                      )
                                    }
                                  >
                                    Concluir
                                  </Button>
                                )}
                                {prazo.status ===
                                  ProcessoPrazoStatus.CONCLUIDO && (
                                  <Button
                                    color="warning"
                                    isLoading={prazoActionId === prazo.id}
                                    size="sm"
                                    startContent={<Clock className="h-3 w-3" />}
                                    variant="flat"
                                    onPress={() =>
                                      handlePrazoStatus(
                                        prazo.id,
                                        ProcessoPrazoStatus.ABERTO,
                                      )
                                    }
                                  >
                                    Reabrir
                                  </Button>
                                )}
                                <Button
                                  isIconOnly
                                  color="danger"
                                  isLoading={prazoActionId === prazo.id}
                                  size="sm"
                                  variant="light"
                                  onPress={() => handleDeletePrazo(prazo.id)}
                                >
                                  <Trash2 className="h-4 w-4" />
                                </Button>
                              </div>
                            )}
                          </div>
                        </CardBody>
                      </Card>
                    );
                  })
                )}
              </CardBody>
            </Card>

            {!isCliente && (
              <Card className="border border-default-200">
                <CardHeader>
                  <h3 className="text-lg font-semibold flex items-center gap-2">
                    <Plus className="h-4 w-4" /> Registrar novo prazo
                  </h3>
                </CardHeader>
                <Divider />
                <CardBody className="space-y-4">
                  <Input
                    label="Título do prazo"
                    placeholder="Ex: Apresentar contestação"
                    value={prazoForm.titulo}
                    onValueChange={(value) =>
                      setPrazoForm((prev) => ({ ...prev, titulo: value }))
                    }
                  />

                  <DateInput
                    label="Data de vencimento"
                    startContent={
                      <Calendar className="h-4 w-4 text-default-400" />
                    }
                    value={prazoForm.dataVencimento}
                    onValueChange={(value) =>
                      setPrazoForm((prev) => ({
                        ...prev,
                        dataVencimento: value,
                      }))
                    }
                  />

                  <Textarea
                    label="Descrição"
                    minRows={2}
                    value={prazoForm.descricao}
                    onValueChange={(value) =>
                      setPrazoForm((prev) => ({ ...prev, descricao: value }))
                    }
                  />

                  <Textarea
                    label="Fundamento legal"
                    minRows={2}
                    value={prazoForm.fundamentoLegal}
                    onValueChange={(value) =>
                      setPrazoForm((prev) => ({
                        ...prev,
                        fundamentoLegal: value,
                      }))
                    }
                  />

                  <div className="flex justify-end">
                    <Button
                      color="primary"
                      isLoading={isCreatingPrazo}
                      startContent={<Plus className="h-4 w-4" />}
                      onPress={handleCreatePrazo}
                    >
                      Adicionar prazo
                    </Button>
                  </div>
                </CardBody>
              </Card>
            )}
          </div>
        </Tab>

        <Tab
          key="documentos"
          title={
            <div className="flex items-center gap-2">
              <FileText className="h-4 w-4" />
              <span>Documentos</span>
              {processo._count.documentos > 0 && (
                <Chip size="sm" variant="flat">
                  {processo._count.documentos}
                </Chip>
              )}
            </div>
          }
        >
          <div
            className="mt-4 space-y-4 scroll-mt-24"
            id="processo-eventos"
          >
            {isLoadingDocs ? (
              <div className="flex justify-center py-8">
                <Spinner />
              </div>
            ) : !documentos || documentos.length === 0 ? (
              <Card className="border border-default-200">
                <CardBody className="py-12 text-center">
                  <FileText className="mx-auto h-12 w-12 text-default-300" />
                  <p className="mt-4 text-lg font-semibold text-default-600">
                    Nenhum documento disponível
                  </p>
                </CardBody>
              </Card>
            ) : (
              <div className="grid gap-3 md:grid-cols-2">
                {documentos.map((doc: any) => (
                  <Card key={doc.id} className="border border-default-200">
                    <CardBody className="gap-2">
                      <div className="flex items-start justify-between">
                        <div className="flex-1">
                          <p className="text-sm font-semibold">
                            {doc.titulo || doc.nomeArquivo}
                          </p>
                          <p className="text-xs text-default-400">
                            {DateUtils.formatDate(doc.createdAt)}
                          </p>
                        </div>
                        {doc.tamanho && (
                          <Chip size="sm" variant="flat">
                            {(doc.tamanho / 1024).toFixed(2)} KB
                          </Chip>
                        )}
                      </div>
                      {doc.descricao && (
                        <p className="text-xs text-default-500">
                          {doc.descricao}
                        </p>
                      )}
                      {doc.url && (
                        <Button
                          as="a"
                          color="primary"
                          href={doc.url}
                          rel="noopener noreferrer"
                          size="sm"
                          startContent={<Eye className="h-3 w-3" />}
                          target="_blank"
                          variant="flat"
                        >
                          Visualizar
                        </Button>
                      )}
                    </CardBody>
                  </Card>
                ))}
              </div>
            )}
          </div>
        </Tab>

        <Tab
          key="eventos"
          title={
            <div className="flex items-center gap-2">
              <Calendar className="h-4 w-4" />
              <span>Eventos</span>
              {processo._count.eventos > 0 && (
                <Chip size="sm" variant="flat">
                  {processo._count.eventos}
                </Chip>
              )}
            </div>
          }
        >
          <div
            className="mt-4 space-y-4 scroll-mt-24"
            id="processo-procuracoes"
          >
            {isLoadingEventos ? (
              <div className="flex justify-center py-8">
                <Spinner />
              </div>
            ) : !eventos || eventos.length === 0 ? (
              <Card className="border border-default-200">
                <CardBody className="py-12 text-center">
                  <Calendar className="mx-auto h-12 w-12 text-default-300" />
                  <p className="mt-4 text-lg font-semibold text-default-600">
                    Nenhum evento cadastrado
                  </p>
                </CardBody>
              </Card>
            ) : (
              <div className="space-y-3">
                {eventos.map((evento: any) => (
                  <Card key={evento.id} className="border border-default-200">
                    <CardBody className="gap-2">
                      <div className="flex items-start justify-between">
                        <div>
                          <p className="text-sm font-semibold">
                            {evento.titulo}
                          </p>
                          <p className="text-xs text-default-400">
                            {DateUtils.formatDateTime(evento.dataInicio)}
                          </p>
                        </div>
                        {evento.status && (
                          <Chip
                            color={
                              evento.status === "CONFIRMADO"
                                ? "success"
                                : "default"
                            }
                            size="sm"
                            variant="flat"
                          >
                            {evento.status}
                          </Chip>
                        )}
                      </div>
                      {evento.descricao && (
                        <p className="text-xs text-default-500">
                          {evento.descricao}
                        </p>
                      )}
                      {evento.local && (
                        <div className="flex items-center gap-1 text-xs text-default-400">
                          <MapPin className="h-3 w-3" />
                          <span>{evento.local}</span>
                        </div>
                      )}
                    </CardBody>
                  </Card>
                ))}
              </div>
            )}
          </div>
        </Tab>

        <Tab
          key="procuracoes"
          title={
            <div className="flex items-center gap-2">
              <FileSignature className="h-4 w-4" />
              <span>Procurações</span>
              {processo.procuracoesVinculadas.length > 0 && (
                <Chip size="sm" variant="flat">
                  {processo.procuracoesVinculadas.length}
                </Chip>
              )}
            </div>
          }
        >
          <div className="mt-4 space-y-4">
            <Card className="border border-default-200">
              <CardHeader>
                <div className="flex items-center justify-between w-full">
                  <h3 className="text-lg font-semibold">
                    Procurações vinculadas
                  </h3>
                  <Chip variant="flat">
                    {processo.procuracoesVinculadas.length}
                  </Chip>
                </div>
              </CardHeader>
              <Divider />
              <CardBody className="space-y-3">
                {processo.procuracoesVinculadas.length === 0 ? (
                  <p className="text-sm text-default-500">
                    Nenhuma procuração vinculada a este processo.
                  </p>
                ) : (
                  processo.procuracoesVinculadas.map((item) => (
                    <Card key={item.id} className="border border-default-200">
                      <CardBody className="gap-2">
                        <div className="flex items-start justify-between gap-3">
                          <div className="space-y-1">
                            <div className="flex items-center gap-2 flex-wrap">
                              <Chip
                                color={
                                  item.procuracao.ativa ? "success" : "danger"
                                }
                                size="sm"
                                variant="flat"
                              >
                                {item.procuracao.status}
                              </Chip>
                              <span className="text-sm font-semibold text-default-700">
                                Procuração{" "}
                                {item.procuracao.numero || "(sem número)"}
                              </span>
                            </div>
                            {item.procuracao.arquivoUrl && (
                              <Button
                                as="a"
                                color="primary"
                                href={item.procuracao.arquivoUrl}
                                rel="noopener noreferrer"
                                size="sm"
                                startContent={<Download className="h-3 w-3" />}
                                target="_blank"
                                variant="flat"
                              >
                                Baixar arquivo
                              </Button>
                            )}
                            <div className="text-xs text-default-500 space-y-1">
                              {item.procuracao.assinaturas.length > 0 && (
                                <p>
                                  <strong>Assinada em:</strong>{" "}
                                  {DateUtils.formatDate(
                                    item.procuracao.assinaturas[0].assinadaEm ??
                                      new Date(),
                                  )}
                                </p>
                              )}
                              {item.procuracao.validaAte && (
                                <p>
                                  <strong>Validade:</strong>{" "}
                                  {DateUtils.formatDate(
                                    item.procuracao.validaAte,
                                  )}
                                </p>
                              )}
                              {item.procuracao.outorgados.length > 0 && (
                                <p>
                                  <strong>Outorgados:</strong>{" "}
                                  {item.procuracao.outorgados
                                    .map((out) =>
                                      `${out.advogado.usuario?.firstName || ""} ${out.advogado.usuario?.lastName || ""}`.trim(),
                                    )
                                    .join(", ")}
                                </p>
                              )}
                            </div>
                          </div>
                          {!isCliente && (
                            <Button
                              isIconOnly
                              color="danger"
                              isLoading={
                                procuracaoActionId === item.procuracao.id
                              }
                              size="sm"
                              variant="light"
                              onPress={() =>
                                handleUnlinkProcuracao(item.procuracao.id)
                              }
                            >
                              <Trash2 className="h-4 w-4" />
                            </Button>
                          )}
                        </div>
                      </CardBody>
                    </Card>
                  ))
                )}
              </CardBody>
            </Card>

            {!isCliente && (
              <Card className="border border-default-200">
                <CardHeader>
                  <h3 className="text-lg font-semibold flex items-center gap-2">
                    <Plus className="h-4 w-4" /> Vincular procuração existente
                  </h3>
                </CardHeader>
                <Divider />
                <CardBody className="space-y-4">
                  <Select
                    isDisabled={procuracoesDisponiveisFiltradas.length === 0}
                    label="Procuração"
                    placeholder="Selecione uma procuração ativa"
                    selectedKeys={
                      selectedProcuracaoId ? [selectedProcuracaoId] : []
                    }
                    onSelectionChange={(keys) => {
                      const key = Array.from(keys)[0] as string | undefined;

                      setSelectedProcuracaoId(key ?? "");
                    }}
                  >
                    {procuracoesDisponiveisFiltradas.map((proc: any) => (
                      <SelectItem
                        key={proc.id}
                        textValue={proc.numero || proc.id}
                      >
                        <div className="flex flex-col">
                          <span className="text-sm font-semibold">
                            {proc.numero || "Sem número"}
                          </span>
                          <span className="text-xs text-default-400">
                            Emitida em{" "}
                            {proc.emitidaEm
                              ? DateUtils.formatDate(proc.emitidaEm)
                              : "-"}
                          </span>
                        </div>
                      </SelectItem>
                    ))}
                  </Select>

                  <div className="flex justify-end">
                    <Button
                      color="primary"
                      isDisabled={!selectedProcuracaoId}
                      isLoading={isLinkingProcuracao}
                      startContent={<Link2 className="h-4 w-4" />}
                      onPress={handleLinkProcuracao}
                    >
                      Vincular procuração
                    </Button>
                  </div>

                  {procuracoesDisponiveisFiltradas.length === 0 && (
                    <p className="text-xs text-default-500">
                      Nenhuma procuração ativa disponível para vincular.
                    </p>
                  )}
                </CardBody>
              </Card>
            )}
          </div>
        </Tab>
      </Tabs>

      {/* Modal do Juiz */}
      {processo.juiz && (
        <JuizModal
          isOpen={isJuizModalOpen}
          juizId={processo.juiz.id}
          onClose={() => setIsJuizModalOpen(false)}
        />
      )}
    </div>
  );
}
