name: Testes

on:
  push:
    branches: [main, develop, 'feature/**']
  pull_request:
    branches: [main, develop]

# Vari치veis padr칚o (podem ser sobrescritas por secrets)
env:
  NODE_ENV: test
  TEST_MODE: 'true'

jobs:
  validate-env:
    name: Validar Configura칞칚o
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Validar vari치veis de ambiente
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL || 'postgresql://postgres:postgres@localhost:5432/magiclawyer_test' }}
          REDIS_URL: ${{ secrets.REDIS_URL || 'redis://localhost:6379' }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET || 'test-secret-key-for-ci' }}
          NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL || 'http://localhost:3000' }}
          TEST_ADMIN_EMAIL: ${{ secrets.TEST_ADMIN_EMAIL }}
          TEST_ADMIN_PASSWORD: ${{ secrets.TEST_ADMIN_PASSWORD }}
          TEST_ADVOGADO_EMAIL: ${{ secrets.TEST_ADVOGADO_EMAIL }}
          TEST_ADVOGADO_PASSWORD: ${{ secrets.TEST_ADVOGADO_PASSWORD }}
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
          CI: 'true'
        run: |
          node scripts/validate-ci-env.js || exit 0  # N칚o falhar o workflow, apenas avisar

  unit-tests:
    name: Testes Unit치rios
    runs-on: ubuntu-latest
    needs: validate-env

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: magiclawyer_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
          --shm-size=256mb
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
          --memory 512m
          --maxmemory-policy allkeys-lru
        ports:
          - 6379:6379

    env:
      DATABASE_URL: postgresql://postgres:postgres@localhost:5432/magiclawyer_test
      REDIS_URL: redis://localhost:6379
      NODE_ENV: test
      NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET || 'test-secret-key-for-ci' }}
      NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL || 'http://localhost:3000' }}
      TEST_MODE: 'true'

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Run database migrations
        run: npx prisma migrate deploy

      - name: Monitorar mem칩ria dos services
        run: |
          echo "游늵 Status dos servi칞os:"
          docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          echo ""
          echo "游 Uso de mem칩ria:"
          docker stats --no-stream --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.MemPerc}}"

      - name: Run unit tests
        run: npm test -- --coverage --ci

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/coverage-final.json
          flags: unit-tests
          name: codecov-umbrella
        continue-on-error: true

  e2e-tests:
    name: Testes E2E
    runs-on: ubuntu-latest
    needs: validate-env

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: magiclawyer_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
          --shm-size=256mb
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
          --memory 512m
          --maxmemory-policy allkeys-lru
        ports:
          - 6379:6379

    env:
      DATABASE_URL: postgresql://postgres:postgres@localhost:5432/magiclawyer_test
      REDIS_URL: redis://localhost:6379
      NODE_ENV: test
      NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET || 'test-secret-key-for-ci' }}
      NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL || 'http://localhost:3000' }}
      TEST_MODE: 'true'
      TEST_ADMIN_EMAIL: ${{ secrets.TEST_ADMIN_EMAIL }}
      TEST_ADMIN_PASSWORD: ${{ secrets.TEST_ADMIN_PASSWORD }}
      TEST_ADVOGADO_EMAIL: ${{ secrets.TEST_ADVOGADO_EMAIL }}
      TEST_ADVOGADO_PASSWORD: ${{ secrets.TEST_ADVOGADO_PASSWORD }}
      TEST_SECRETARIA_EMAIL: ${{ secrets.TEST_SECRETARIA_EMAIL }}
      TEST_SECRETARIA_PASSWORD: ${{ secrets.TEST_SECRETARIA_PASSWORD }}
      TEST_FINANCEIRO_EMAIL: ${{ secrets.TEST_FINANCEIRO_EMAIL }}
      TEST_FINANCEIRO_PASSWORD: ${{ secrets.TEST_FINANCEIRO_PASSWORD }}
      TEST_CLIENTE_EMAIL: ${{ secrets.TEST_CLIENTE_EMAIL }}
      TEST_CLIENTE_PASSWORD: ${{ secrets.TEST_CLIENTE_PASSWORD }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Run database migrations
        run: npx prisma migrate deploy

      - name: Monitorar mem칩ria dos services
        run: |
          echo "游늵 Status dos servi칞os:"
          docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          echo ""
          echo "游 Uso de mem칩ria:"
          docker stats --no-stream --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.MemPerc}}"

      - name: Build application
        run: npm run build

      - name: Run E2E tests
        run: npm run test:e2e
        env:
          BASE_URL: http://localhost:3000

      - name: Monitorar mem칩ria ap칩s testes
        if: always()
        run: |
          echo "游늵 Status final dos servi칞os:"
          docker stats --no-stream --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.MemPerc}}"

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

  lint:
    name: Lint
    runs-on: ubuntu-latest
    needs: validate-env

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

