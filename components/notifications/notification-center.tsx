"use client";

import { useMemo, useEffect, useState } from "react";
import { useRouter } from "next/navigation";
import { Button } from "@heroui/button";
import { Badge } from "@heroui/badge";
import { Chip } from "@heroui/chip";
import {
  Drawer,
  DrawerBody,
  DrawerContent,
  DrawerFooter,
  DrawerHeader,
} from "@heroui/drawer";
import {
  Modal,
  ModalBody,
  ModalContent,
  ModalFooter,
  ModalHeader,
} from "@heroui/modal";
import { ScrollShadow } from "@heroui/scroll-shadow";
import { Spinner } from "@heroui/spinner";
import { Tooltip } from "@heroui/tooltip";
import { addToast } from "@heroui/toast";
import { useDisclosure } from "@heroui/react";

import { useRealtime } from "@/app/providers/realtime-provider";
import {
  useNotifications,
  type NotificationStatus,
  type NotificationItem,
} from "@/app/hooks/use-notifications";
import { BellIcon } from "@/components/icons";

const statusCopy: Record<NotificationStatus, string> = {
  NAO_LIDA: "Não lida",
  LIDA: "Lida",
  ARQUIVADA: "Arquivada",
};

const statusColor: Record<
  NotificationStatus,
  "primary" | "success" | "default"
> = {
  NAO_LIDA: "primary",
  LIDA: "success",
  ARQUIVADA: "default",
};

function formatDate(dateIso: string) {
  const date = new Date(dateIso);

  return new Intl.DateTimeFormat("pt-BR", {
    dateStyle: "short",
    timeStyle: "short",
  }).format(date);
}

export const NotificationCenter = () => {
  const disclosure = useDisclosure();
  const detailDisclosure = useDisclosure();
  const [selectedNotification, setSelectedNotification] =
    useState<NotificationItem | null>(null);
  const router = useRouter();
  const {
    notifications,
    unreadCount,
    isLoading,
    isValidating,
    mutate: mutateNotifications,
    markAs,
    markAllAsRead,
    clearAll,
  } = useNotifications();
  const { subscribe } = useRealtime();

  // Hook para notificações de desenvolvimento (só em DEV)
  const totalUnreadCount = unreadCount;

  const resolveReferenceLink = (item: NotificationItem): string | null => {
    if (!item.referenciaTipo || !item.referenciaId) {
      return null;
    }

    const tipo = item.referenciaTipo.toLowerCase().trim();

    switch (tipo) {
      case "documento":
        return "/documentos";
      case "evento":
        return "/agenda";
      case "pagamento":
        return "/financeiro/recibos";
      case "cliente":
        return "/clientes";
      case "processo":
      default:
        return `/processos/${item.referenciaId}`;
    }
  };

  const handleOpenDetails = (item: NotificationItem) => {
    if (item.status === "NAO_LIDA") {
      void handleStatusChange(item.id, "LIDA");
    }
    setSelectedNotification(item);
    detailDisclosure.onOpen();
  };

  const handleCloseDetails = () => {
    setSelectedNotification(null);
    detailDisclosure.onClose();
  };

  const unreadBadge = useMemo(() => {
    if (totalUnreadCount <= 0) return null;

    return (
      <Badge
        className="border-none bg-danger text-[10px] font-semibold text-white shadow-lg"
        content={totalUnreadCount > 99 ? "99+" : totalUnreadCount}
        placement="top-right"
      >
        <span className="sr-only">Notificações não lidas</span>
      </Badge>
    );
  }, [totalUnreadCount]);

  // Realtime: invalidar quando chegar notification.new para o usuário atual
  useEffect(() => {
    const unsubscribe = subscribe("notification.new", () => {
      // Invalida apenas cache SWR das notificações, sem refresh global
      void mutateNotifications();
    });

    return unsubscribe;
  }, [subscribe, mutateNotifications]);

  const detailPayload = useMemo(() => {
    if (
      !selectedNotification ||
      !selectedNotification.dados ||
      typeof selectedNotification.dados !== "object"
    ) {
      return null;
    }

    return selectedNotification.dados as Record<string, any>;
  }, [selectedNotification]);

  const detailDiffItems = useMemo(() => {
    if (!detailPayload) {
      return [] as Array<Record<string, any>>;
    }

    const diffCandidate = (detailPayload as any).diff;

    return Array.isArray(diffCandidate) ? diffCandidate : [];
  }, [detailPayload]);

  const handleStatusChange = async (id: string, status: NotificationStatus) => {
    try {
      await markAs(id, status);
    } catch (error) {
      const message =
        error instanceof Error
          ? error.message
          : "Falha ao atualizar notificação.";

      addToast({
        title: "Não foi possível atualizar",
        description: message,
        color: "danger",
      });
    }
  };

  const handleClearAll = async () => {
    try {
      await clearAll();
      addToast({
        title: "Notificações limpas",
        description: "Suas notificações foram removidas.",
        color: "success",
      });
    } catch (error) {
      const message =
        error instanceof Error
          ? error.message
          : "Não foi possível limpar as notificações.";

      addToast({
        title: "Erro ao limpar",
        description: message,
        color: "danger",
      });
    }
  };

  const handleMarkAllAsRead = async () => {
    try {
      await markAllAsRead();
      addToast({
        title: "Tudo lido",
        description: "Todas as notificações foram marcadas como lidas.",
        color: "success",
      });
    } catch (error) {
      const message =
        error instanceof Error
          ? error.message
          : "Não foi possível marcar todas como lidas.";

      addToast({
        title: "Erro ao marcar",
        description: message,
        color: "danger",
      });
    }
  };

  const hasNotifications = notifications.length > 0;

  return (
    <div className="relative">
      <Tooltip color="primary" content="Notificações" placement="bottom">
        <Button
          isIconOnly
          aria-label="Abrir notificações"
          className="relative rounded-full border border-white/10 bg-white/5 p-0 text-default-500 shadow-lg transition hover:border-primary/40 hover:text-primary"
          radius="full"
          variant="light"
          onPress={disclosure.onOpen}
        >
          {unreadBadge}
          <BellIcon className="h-5 w-5" />
        </Button>
      </Tooltip>

      <Drawer
        isOpen={disclosure.isOpen}
        motionProps={{
          variants: {
            enter: { x: 0 },
            exit: { x: 600 },
          },
        }}
        placement="right"
        size="xl"
        onOpenChange={disclosure.onOpenChange}
      >
        <DrawerContent className="border-l border-white/10 bg-background/70 backdrop-blur-3xl">
          {(onClose) => (
            <>
              <DrawerHeader className="flex items-center justify-between gap-4">
                <div className="flex flex-col">
                  <span className="text-sm font-semibold uppercase tracking-[0.3em] text-primary">
                    Central
                  </span>
                  <h2 className="text-lg font-semibold text-white">
                    Notificações
                  </h2>
                </div>
                <Chip className="text-xs" color="primary" variant="flat">
                  {isValidating
                    ? "Atualizando"
                    : `${totalUnreadCount} não lida(s)`}
                </Chip>
              </DrawerHeader>

              <DrawerBody className="px-0 pb-0">
                {isLoading && !hasNotifications ? (
                  <div className="flex h-48 items-center justify-center">
                    <Spinner color="primary" label="Carregando notificações" />
                  </div>
                ) : null}

                {!isLoading && !hasNotifications ? (
                  <div className="flex h-48 flex-col items-center justify-center gap-2 text-center text-default-400">
                    <BellIcon className="h-10 w-10 text-default-200" />
                    <p className="text-sm font-medium text-white">
                      Nenhuma notificação por aqui
                    </p>
                    <p className="text-xs text-default-400">
                      Quando algo importante acontecer, você será avisado.
                    </p>
                  </div>
                ) : null}

                {hasNotifications ? (
                  <ScrollShadow className="max-h-[60vh] px-6 pb-6">
                    <ul className="space-y-4">
                      {notifications.map((item) => {
                        const isUnread = item.status === "NAO_LIDA";

                        return (
                          <li
                            key={item.id}
                            className="group rounded-2xl border border-white/10 bg-white/5 p-4 shadow-lg transition hover:border-primary/40 hover:bg-primary/5"
                            role="button"
                            tabIndex={0}
                            onClick={() => handleOpenDetails(item)}
                            onKeyDown={(event) => {
                              if (event.key === "Enter" || event.key === " ") {
                                event.preventDefault();
                                handleOpenDetails(item);
                              }
                            }}
                          >
                            <div className="flex items-start justify-between gap-3">
                              <div className="flex flex-col gap-1">
                                <div className="flex items-center gap-2">
                                  <span className="text-sm font-semibold text-white">
                                    {item.titulo}
                                  </span>
                                  <Chip
                                    className="text-[10px]"
                                    color={statusColor[item.status]}
                                    size="sm"
                                    variant="flat"
                                  >
                                    {statusCopy[item.status]}
                                  </Chip>
                                </div>
                                <p className="text-sm text-default-400">
                                  {item.mensagem}
                                </p>
                              </div>
                              <span className="shrink-0 text-xs text-default-300">
                                {formatDate(item.criadoEm)}
                              </span>
                            </div>

                            <div
                              className="mt-3 flex flex-wrap items-center gap-2"
                              onClick={(event) => event.stopPropagation()}
                            >
                              {isUnread ? (
                                <Button
                                  color="primary"
                                  size="sm"
                                  variant="flat"
                                  onPress={() =>
                                    handleStatusChange(item.id, "LIDA")
                                  }
                                >
                                  Marcar como lida
                                </Button>
                              ) : (
                                <Button
                                  size="sm"
                                  variant="light"
                                  onPress={() =>
                                    handleStatusChange(item.id, "NAO_LIDA")
                                  }
                                >
                                  Marcar como não lida
                                </Button>
                              )}
                              <Button
                                size="sm"
                                variant="light"
                                onPress={() =>
                                  handleStatusChange(item.id, "ARQUIVADA")
                                }
                              >
                                Arquivar
                              </Button>
                              <Button
                                size="sm"
                                variant="bordered"
                                onPress={() => handleOpenDetails(item)}
                              >
                                Ver detalhes
                              </Button>
                            </div>
                          </li>
                        );
                      })}
                    </ul>
                  </ScrollShadow>
                ) : null}
              </DrawerBody>

              <DrawerFooter className="flex flex-col gap-2 border-t border-white/10 bg-background/60">
                <div className="flex w-full items-center justify-between text-xs text-default-400">
                  <span>Sistema de notificações ativo</span>
                  <span>{notifications.length} registro(s)</span>
                </div>
                <div className="flex w-full flex-wrap gap-3">
                  <Button
                    className="flex-1"
                    isDisabled={totalUnreadCount === 0}
                    variant="bordered"
                    onPress={handleMarkAllAsRead}
                  >
                    Marcar todas como lidas
                  </Button>
                  <Button
                    className="flex-1"
                    color="primary"
                    variant="flat"
                    onPress={handleClearAll}
                  >
                    Limpar notificações
                  </Button>
                  <Button className="flex-1" variant="light" onPress={onClose}>
                    Fechar
                  </Button>
                </div>
              </DrawerFooter>
            </>
          )}
        </DrawerContent>
      </Drawer>
      <Modal
        classNames={{
          base: "bg-background/95 backdrop-blur-lg border border-white/10",
        }}
        isOpen={detailDisclosure.isOpen && !!selectedNotification}
        scrollBehavior="inside"
        size="lg"
        onClose={handleCloseDetails}
      >
        <ModalContent>
          {() => {
            const notification = selectedNotification;
            const referenceHref = notification
              ? resolveReferenceLink(notification)
              : null;
            const summary = detailPayload?.changesSummary as string | undefined;
            const statusSummary =
              (detailPayload?.statusSummary as string | undefined) ??
              (detailPayload?.oldStatusLabel && detailPayload?.newStatusLabel
                ? `Status alterado de ${detailPayload.oldStatusLabel} para ${detailPayload.newStatusLabel}`
                : undefined);
            const additionalSummary =
              detailPayload?.additionalChangesSummary as string | undefined;

            return (
              <>
                <ModalHeader className="flex flex-col gap-1">
                  <span className="text-xs font-medium uppercase tracking-wide text-default-400">
                    {notification ? formatDate(notification.criadoEm) : ""}
                  </span>
                  <span className="text-lg font-semibold text-white">
                    {notification?.titulo ?? "Detalhes da notificação"}
                  </span>
                </ModalHeader>
                <ModalBody className="space-y-4">
                  {notification?.mensagem ? (
                    <p className="text-sm text-default-300">
                      {notification.mensagem}
                    </p>
                  ) : null}

                  {statusSummary ? (
                    <div className="rounded-lg border border-primary/40 bg-primary/10 p-3 text-sm text-primary-100">
                      {statusSummary}
                    </div>
                  ) : null}

                  {summary ? (
                    <div className="rounded-lg border border-white/10 bg-white/5 p-3 text-sm text-default-300">
                      Campos atualizados: {summary}
                    </div>
                  ) : null}

                  {!summary && additionalSummary ? (
                    <div className="rounded-lg border border-white/10 bg-white/5 p-3 text-sm text-default-300">
                      Outras alterações: {additionalSummary}
                    </div>
                  ) : null}

                  {detailDiffItems.length > 0 ? (
                    <div className="overflow-hidden rounded-xl border border-white/10">
                      <table className="w-full text-left text-sm">
                        <thead className="bg-white/5 text-xs uppercase tracking-wide text-default-500">
                          <tr>
                            <th className="px-4 py-2 font-semibold">Campo</th>
                            <th className="px-4 py-2 font-semibold">Antes</th>
                            <th className="px-4 py-2 font-semibold">Depois</th>
                          </tr>
                        </thead>
                        <tbody className="divide-y divide-white/5">
                          {detailDiffItems.map((change: any, index: number) => (
                            <tr key={change.field ?? index}>
                              <td className="px-4 py-2 text-sm font-medium text-white">
                                {change.label ?? change.field ?? "-"}
                              </td>
                              <td className="px-4 py-2 text-sm text-default-400">
                                {change.before ?? "—"}
                              </td>
                              <td className="px-4 py-2 text-sm text-default-200">
                                {change.after ?? "—"}
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  ) : (
                    <p className="text-sm text-default-400">
                      Nenhum detalhamento de alteração disponível.
                    </p>
                  )}
                </ModalBody>
                <ModalFooter className="flex flex-wrap justify-end gap-2">
                  <Button variant="light" onPress={handleCloseDetails}>
                    Fechar
                  </Button>
                  {selectedNotification &&
                  selectedNotification.status === "NAO_LIDA" ? (
                    <Button
                      variant="flat"
                      onPress={() => {
                        void handleStatusChange(
                          selectedNotification.id,
                          "LIDA",
                        );
                      }}
                    >
                      Marcar como lida
                    </Button>
                  ) : null}
                  {referenceHref ? (
                    <Button
                      color="primary"
                      onPress={() => {
                        handleCloseDetails();
                        disclosure.onClose();
                        router.push(referenceHref);
                      }}
                    >
                      Abrir registro
                    </Button>
                  ) : null}
                </ModalFooter>
              </>
            );
          }}
        </ModalContent>
      </Modal>
    </div>
  );
};
